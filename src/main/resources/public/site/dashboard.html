<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Dashboard de Monitoramento de Rede</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Tom de cinza levemente azulado, mais suave */
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh; /* Garante que o corpo ocupe pelo menos a altura da tela */
        }

        h1 {
            font-size: 2.2rem; /* Um pouco maior */
            color: #172b4d; /* Azul mais escuro e corporativo */
            margin-bottom: 25px; /* Ajuste */
            text-align: center;
            font-weight: 600;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); /* Ajuste minmax */
            gap: 25px; /* Aumentar um pouco o espa√ßamento */
            width: 100%;
            max-width: 1300px; /* Um pouco mais de largura m√°xima */
        }

        .panel {
            background-color: #ffffff;
            padding: 25px; /* Aumentar padding */
            border-radius: 10px; /* Bordas mais arredondadas */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); /* Sombra mais suave */
            min-height: 220px; /* Ajuste */
            display: flex; /* Para melhor controle do conte√∫do interno */
            flex-direction: column;
        }

        .panel h2 {
            font-size: 1.3rem; /* Ajuste de tamanho */
            color: #0052cc; /* Azul mais vibrante para t√≠tulos de painel */
            margin-top: 0;
            margin-bottom: 20px;
            border-bottom: 2px solid #dfe1e6; /* Linha divis√≥ria mais sutil */
            padding-bottom: 12px;
            font-weight: 600;
        }

        /* Estilos para tabelas e listas */
        table {
            width: 100%;
            border-collapse: collapse; /* Remove espa√ßos entre c√©lulas */
        }

        thead th {
            background-color: #f7f8f9; /* Fundo do cabe√ßalho da tabela */
            color: #172b4d;
            font-weight: 600; /* Cabe√ßalho em negrito */
            padding: 12px 10px; /* Mais padding */
            text-align: left;
            font-size: 0.95rem;
            border-bottom: 2px solid #dfe1e6;
        }

        tbody td {
            padding: 10px; /* Padding nas c√©lulas */
            border-bottom: 1px solid #f0f2f5; /* Linha mais sutil */
            font-size: 0.9rem;
            color: #42526e; /* Cor de texto mais suave */
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        tbody tr:hover {
            background-color: #f7f8f9; /* Efeito hover nas linhas */
        }

        ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
            flex-grow: 1; /* Para que a lista ocupe o espa√ßo dispon√≠vel no painel */
        }

        ul li {
            padding: 10px 5px; /* Ajuste de padding */
            border-bottom: 1px solid #f0f2f5;
            font-size: 0.9rem;
            color: #42526e;
            display: flex; /* Para alinhar itens na lista, se necess√°rio */
            justify-content: space-between;
        }

        ul li:last-child {
            border-bottom: none;
        }

        .timestamp {
            font-size: 0.8em;
            color: #5e6c84; /* Cor do timestamp */
            margin-left: 8px; /* Espa√ßo √† esquerda */
        }

        .log-entry {
            padding: 8px 5px; /* Ajuste de padding */
            border-bottom: 1px dotted #e0e0e0; /* Linha pontilhada mais sutil */
            font-size: 0.85rem;
            color: #42526e;
            line-height: 1.5;
        }
        #system-logs { 
            max-height: 300px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        /* Status Colors */
        .status-ok { color: #00875a; /* Verde mais escuro */ }
        .status-blocked { color: #de350b; font-weight: bold; /* Vermelho mais forte */ }
        .status-alert { color: #ffab00; /* Laranja/Amarelo para alertas */ }
        .status-info { color: #0052cc; /* Azul para informa√ß√µes gerais */ }


        /* Bot√£o de Reset */
        .reset-button-container {
            display: flex; /* Alinhar bot√£o e status na mesma linha */
            flex-direction: column; /* Ou column se preferir um abaixo do outro */
            align-items: center;
            gap: 10px; /* Espa√ßo entre bot√£o e mensagem de status */
            margin-bottom: 25px;
        }

        button#resetBlockedIps {
            padding: 12px 25px; /* Mais padding */
            background-color: #de350b;
            color: white;
            border: none;
            border-radius: 6px; /* Bordas levemente mais arredondadas */
            font-size: 1rem;
            font-weight: 600; /* Texto do bot√£o em negrito */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease;
        }

        button#resetBlockedIps:hover {
            background-color: #bf2600; /* Vermelho mais escuro no hover */
            transform: translateY(-1px); /* Leve efeito de eleva√ß√£o */
        }
        button#resetBlockedIps:active {
            transform: translateY(0px); /* Efeito de clique */
        }


        #resetStatus {
            margin-top: 5px; /* Ajuste de margem */
            font-size: 0.9rem;
            color: #172b4d;
            min-height: 1.2em; /* Para evitar que o layout pule quando o texto aparece */
        }

        /* Indicador de Conex√£o WebSocket (NOVO) */
        #ws-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.85rem;
            font-weight: 600;
            z-index: 1000;
        }

        .ws-connected {
            background-color: #e3fcef;
            color: #006644;
            border: 1px solid #00875a;
        }

        .ws-disconnected {
            background-color: #ffebe6;
            color: #bf2600;
            border: 1px solid #de350b;
        }

    
        .empty-state {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #5e6c84;
            font-style: italic;
            padding: 20px;
            text-align: center;
        }



    </style>
</head>
<body>
<h1>Dashboard de Monitoramento de Rede</h1>

<div class="reset-button-container">
    <button id="resetBlockedIps">Resetar IPs Bloqueados</button>
    <div id="resetStatus"></div>
</div>

<div class="dashboard-container">
    <div class="panel">
        <h2>üìä Requisi√ß√µes por IP</h2>
        <table id="requests-per-ip-table">
            <thead>
            <tr>
                <th>IP</th>
                <th>Contagem</th>
            </tr>
            </thead>
            <tbody id="requests-per-ip"></tbody>
        </table>
    </div>

    <div class="panel">
        <h2>üö´ IPs Bloqueados</h2>
        <ul id="blocked-ips"></ul>
    </div>

    <div class="panel">
        <h2>üì° Requisi√ß√µes Recentes</h2>
        <ul id="recent-requests"></ul>
    </div>

    <div class="panel">
        <h2>üìú Logs do Sistema</h2>
        <div id="system-logs"></div>
    </div>
</div>

<div id="ws-status">Conectando...</div>

<script>
        // Endere√ßo do seu servidor WebSocket
        // Certifique-se de que o caminho /ws ou similar est√° configurado no seu servidor Python
        const WEBSOCKET_URL = `ws://${window.location.host}/ws`; // Assume que o servidor WS est√° no mesmo host e porta, caminho /ws

        const requestsPerIpBody = document.getElementById('requests-per-ip');
        const blockedIpsList = document.getElementById('blocked-ips');
        const recentRequestsList = document.getElementById('recent-requests');
        const systemLogsDiv = document.getElementById('system-logs');
        const wsStatusDiv = document.getElementById('ws-status');
        const resetStatusDiv = document.getElementById('resetStatus');

        function formatRequestsPerIp(data) {
        let html = '';
        if (Object.keys(data).length === 0) {
        return '<tr><td colspan="2"><div class="empty-state">Nenhuma requisi√ß√£o registrada.</div></td></tr>';
    }
        for (const ip in data) {
        html += `<tr><td>${ip}</td><td>${data[ip]}</td></tr>`;
    }
        return html;
    }

        function formatBlockedIps(data) {
        if (!data || data.length === 0) {
        return '<li><div class="empty-state">Nenhum IP bloqueado.</div></li>';
    }
        return data.map(ip => `<li class="status-blocked">${ip}</li>`).join('');
    }

        function formatRecentRequests(data) {
        if (!data || data.length === 0) {
        return '<li><div class="empty-state">Nenhuma requisi√ß√£o recente.</div></li>';
    }
        const displayLimit = 15;
        return data.slice(-displayLimit).reverse().map(req => // Pega as √∫ltimas, inverte para a mais nova no topo
        `<li><span>${req.ip}</span> <span class="timestamp">(${new Date(req.timestamp).toLocaleString()})</span></li>`
        ).join('');
    }

        function formatSystemLogs(data) {
        if (!data || data.length === 0) {
        return '<div class="empty-state">Nenhum log no sistema.</div>';
    }
        // Limitar o n√∫mero de logs exibidos no cliente
        const displayLimit = 30;
        // Adicionar os logs mais recentes no topo
        return data.slice(-displayLimit).reverse().map(log => {
        let logClass = 'status-info'; // Classe padr√£o
        if (log.includes('IP bloqueado')) logClass = 'status-blocked';
        if (log.includes('Erro') || log.includes('Falha')) logClass = 'status-alert';

        // Regex para destacar o IP bloqueado com a classe
        const formattedLog = log.replace(
        /\[ROUTER\] IP bloqueado: ([\d.]+)/g,
        '<span class="status-blocked">[ROUTER] IP bloqueado: $1</span>'
        );
        return `<div class="log-entry ${logClass}">${formattedLog}</div>`;
    }).join('');
    }

        // --- L√≥gica do WebSocket ---
        let socket;

        function connectWebSocket() {
        socket = new WebSocket(WEBSOCKET_URL);

        socket.onopen = function(event) {
        console.log('WebSocket conectado!');
        wsStatusDiv.textContent = 'Conectado';
        wsStatusDiv.className = 'ws-connected';
        // Voc√™ pode solicitar dados iniciais ao servidor aqui, se necess√°rio
        // socket.send(JSON.stringify({ type: 'getInitialData' }));
    };

        socket.onmessage = function(event) {
        try {
        const message = JSON.parse(event.data);
        console.log('Mensagem recebida:', message);


        switch (message.type) {
        case 'stats':
        case 'requests_per_ip': // Manter compatibilidade com o que voc√™ pode estar enviando
        requestsPerIpBody.innerHTML = formatRequestsPerIp(message.payload);
        break;
        case 'blocked_ips':
        blockedIpsList.innerHTML = formatBlockedIps(message.payload);
        break;
        case 'recent_requests':
        recentRequestsList.innerHTML = formatRecentRequests(message.payload);
        break;
        case 'system_logs':
        systemLogsDiv.innerHTML = formatSystemLogs(message.payload);
        break;
        case 'all_data': // Se o servidor enviar todos os dados de uma vez
        if (message.payload.stats) requestsPerIpBody.innerHTML = formatRequestsPerIp(message.payload.stats);
        if (message.payload.blocked_ips) blockedIpsList.innerHTML = formatBlockedIps(message.payload.blocked_ips);
        if (message.payload.recent_requests) recentRequestsList.innerHTML = formatRecentRequests(message.payload.recent_requests);
        if (message.payload.system_logs) systemLogsDiv.innerHTML = formatSystemLogs(message.payload.system_logs);
        break;
        default:
        console.warn('Tipo de mensagem desconhecida:', message.type);
    }
    } catch (error) {
        console.error('Erro ao processar mensagem do WebSocket:', error, 'Dados:', event.data);
    }
    };

        socket.onerror = function(error) {
        console.error('Erro no WebSocket:', error);
        wsStatusDiv.textContent = 'Erro de Conex√£o';
        wsStatusDiv.className = 'ws-disconnected';
    };

        socket.onclose = function(event) {
        console.log('WebSocket desconectado. Tentando reconectar em 3 segundos...');
        wsStatusDiv.textContent = 'Desconectado. Reconectando...';
        wsStatusDiv.className = 'ws-disconnected';
        setTimeout(connectWebSocket, 3000); // Tenta reconectar ap√≥s 3 segundos
    };
    }

        // --- Fun√ß√£o para resetar IPs bloqueados (mant√©m o POST) ---
        async function resetBlockedIps() {
        resetStatusDiv.textContent = 'Resetando...';
        resetStatusDiv.className = 'status-info'; // Usar classes de status
        try {
        // O endpoint /reset deve ser um POST
        const response = await fetch('/reset', { method: 'POST' });
        const text = await response.text(); // Ou response.json() se o servidor responder com JSON

        if (response.ok) {
        resetStatusDiv.textContent = `Sucesso: ${text}`;
        resetStatusDiv.className = 'status-ok';
        // N√£o precisa mais fazer fetch manual aqui.
        // O servidor, ao processar /reset, deve enviar via WebSocket as atualiza√ß√µes
        // para 'blocked_ips' e 'system_logs'.
    } else {
        resetStatusDiv.textContent = `Falha: ${text || response.statusText}`;
        resetStatusDiv.className = 'status-alert';
    }

    } catch (error) {
        console.error('Erro ao resetar IPs bloqueados:', error);
        resetStatusDiv.textContent = 'Erro cr√≠tico ao tentar resetar.';
        resetStatusDiv.className = 'status-alert';
    }
        // Limpar a mensagem de status ap√≥s alguns segundos
        setTimeout(() => {
        resetStatusDiv.textContent = '';
        resetStatusDiv.className = '';
    }, 5000);
    }

        // Adiciona o event listener ao bot√£o de reset
        document.getElementById('resetBlockedIps').addEventListener('click', resetBlockedIps);

        // Iniciar a conex√£o WebSocket quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', () => {
        // Colocar placeholders iniciais
        requestsPerIpBody.innerHTML = '<tr><td colspan="2"><div class="empty-state">Aguardando dados...</div></td></tr>';
        blockedIpsList.innerHTML = '<li><div class="empty-state">Aguardando dados...</div></li>';
        recentRequestsList.innerHTML = '<li><div class="empty-state">Aguardando dados...</div></li>';
        systemLogsDiv.innerHTML = '<div class="empty-state">Aguardando dados...</div>';

        connectWebSocket();
    });

</script>
</script>
</body>
</html>
