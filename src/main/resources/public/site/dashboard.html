<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Dashboard de Monitoramento de Rede</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; 
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            font-size: 2.2rem; 
            color: #172b4d; 
            margin-bottom: 25px; 
            text-align: center;
            font-weight: 600;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); /* Ajuste minmax */
            gap: 25px; 
            width: 100%;
            max-width: 1300px; 
        }

        .panel {
            background-color: #ffffff;
            padding: 25px; 
            border-radius: 10px; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); 
            min-height: 220px; 
            display: flex; 
            flex-direction: column;
        }

        .panel h2 {
            font-size: 1.3rem; 
            color: #0052cc; 
            margin-top: 0;
            margin-bottom: 20px;
            border-bottom: 2px solid #dfe1e6; 
            padding-bottom: 12px;
            font-weight: 600;
        }

        
        table {
            width: 100%;
            border-collapse: collapse; 
        }

        thead th {
            background-color: #f7f8f9; 
            color: #172b4d;
            font-weight: 600; 
            padding: 12px 10px; 
            text-align: left;
            font-size: 0.95rem;
            border-bottom: 2px solid #dfe1e6;
        }

        tbody td {
            padding: 10px; 
            border-bottom: 1px solid #f0f2f5; 
            font-size: 0.9rem;
            color: #42526e; 
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        tbody tr:hover {
            background-color: #f7f8f9; 
        }

        ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
            flex-grow: 1; 
        }

        ul li {
            padding: 10px 5px; 
            border-bottom: 1px solid #f0f2f5;
            font-size: 0.9rem;
            color: #42526e;
            display: flex; 
            justify-content: space-between;
        }

        ul li:last-child {
            border-bottom: none;
        }

        .timestamp {
            font-size: 0.8em;
            color: #5e6c84; 
            margin-left: 8px; 
        }

        .log-entry {
            padding: 8px 5px; 
            border-bottom: 1px dotted #e0e0e0; 
            font-size: 0.85rem;
            color: #42526e;
            line-height: 1.5;
        }
        #system-logs { 
            max-height: 300px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        /* Status Colors */
        .status-ok { color: #00875a;  }
        .status-blocked { color: #de350b; font-weight: bold;  }
        .status-alert { color: #ffab00;  }
        .status-info { color: #0052cc; }


        /* BotÃ£o de Reset */
        .reset-button-container {
            display: flex; 
            flex-direction: column; 
            align-items: center;
            gap: 10px; 
            margin-bottom: 25px;
        }

        button#resetBlockedIps {
            padding: 12px 25px; 
            background-color: #de350b;
            color: white;
            border: none;
            border-radius: 6px; 
            font-size: 1rem;
            font-weight: 600; 
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease;
        }

        button#resetBlockedIps:hover {
            background-color: #bf2600; 
            transform: translateY(-1px); 
        }
        button#resetBlockedIps:active {
            transform: translateY(0px); 
        }


        #resetStatus {
            margin-top: 5px; 
            font-size: 0.9rem;
            color: #172b4d;
            min-height: 1.2em; 
        }

    
        #ws-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.85rem;
            font-weight: 600;
            z-index: 1000;
        }

        .ws-connected {
            background-color: #e3fcef;
            color: #006644;
            border: 1px solid #00875a;
        }

        .ws-disconnected {
            background-color: #ffebe6;
            color: #bf2600;
            border: 1px solid #de350b;
        }

    
        .empty-state {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #5e6c84;
            font-style: italic;
            padding: 20px;
            text-align: center;
        }



    </style>
</head>
<body>
<h1>Dashboard de Monitoramento de Rede</h1>

<div class="reset-button-container">
    <button id="resetBlockedIps">Resetar IPs Bloqueados</button>
    <div id="resetStatus"></div>
</div>

<div class="dashboard-container">
    <div class="panel">
        <h2>ðŸ“Š RequisiÃ§Ãµes por IP</h2>
        <table id="requests-per-ip-table">
            <thead>
            <tr>
                <th>IP</th>
                <th>Contagem</th>
            </tr>
            </thead>
            <tbody id="requests-per-ip"></tbody>
        </table>
    </div>

    <div class="panel">
        <h2>ðŸš« IPs Bloqueados</h2>
        <ul id="blocked-ips"></ul>
    </div>

    <div class="panel">
        <h2>ðŸ“¡ RequisiÃ§Ãµes Recentes</h2>
        <ul id="recent-requests"></ul>
    </div>

    <div class="panel">
        <h2>ðŸ“œ Logs do Sistema</h2>
        <div id="system-logs"></div>
    </div>
</div>

<div id="ws-status">Conectando...</div>

<script>
        // EndereÃ§o do servidor WebSocket
        const WEBSOCKET_URL = `ws://${window.location.host}/ws`; 

        const requestsPerIpBody = document.getElementById('requests-per-ip');
        const blockedIpsList = document.getElementById('blocked-ips');
        const recentRequestsList = document.getElementById('recent-requests');
        const systemLogsDiv = document.getElementById('system-logs');
        const wsStatusDiv = document.getElementById('ws-status');
        const resetStatusDiv = document.getElementById('resetStatus');

        function formatRequestsPerIp(data) {
        let html = '';
        if (Object.keys(data).length === 0) {
        return '<tr><td colspan="2"><div class="empty-state">Nenhuma requisiÃ§Ã£o registrada.</div></td></tr>';
    }
        for (const ip in data) {
        html += `<tr><td>${ip}</td><td>${data[ip]}</td></tr>`;
    }
        return html;
    }

        function formatBlockedIps(data) {
        if (!data || data.length === 0) {
        return '<li><div class="empty-state">Nenhum IP bloqueado.</div></li>';
    }
        return data.map(ip => `<li class="status-blocked">${ip}</li>`).join('');
    }

        function formatRecentRequests(data) {
        if (!data || data.length === 0) {
        return '<li><div class="empty-state">Nenhuma requisiÃ§Ã£o recente.</div></li>';
    }
        const displayLimit = 15;
        return data.slice(-displayLimit).reverse().map(req => // Pega as Ãºltimas, inverte para a mais nova no topo
        `<li><span>${req.ip}</span> <span class="timestamp">(${new Date(req.timestamp).toLocaleString()})</span></li>`
        ).join('');
    }

        function formatSystemLogs(data) {
        if (!data || data.length === 0) {
        return '<div class="empty-state">Nenhum log no sistema.</div>';
    }
        const displayLimit = 30;
        // Adicionar os logs mais recentes no topo
        return data.slice(-displayLimit).reverse().map(log => {
        let logClass = 'status-info'; // Classe padrÃ£o
        if (log.includes('IP bloqueado')) logClass = 'status-blocked';
        if (log.includes('Erro') || log.includes('Falha')) logClass = 'status-alert';

        const formattedLog = log.replace(
        /\[ROUTER\] IP bloqueado: ([\d.]+)/g,
        '<span class="status-blocked">[ROUTER] IP bloqueado: $1</span>'
        );
        return `<div class="log-entry ${logClass}">${formattedLog}</div>`;
    }).join('');
    }

        let socket;

        function connectWebSocket() {
        socket = new WebSocket(WEBSOCKET_URL);

        socket.onopen = function(event) {
        console.log('WebSocket conectado!');
        wsStatusDiv.textContent = 'Conectado';
        wsStatusDiv.className = 'ws-connected';
    };

        socket.onmessage = function(event) {
        try {
        const message = JSON.parse(event.data);
        console.log('Mensagem recebida:', message);


        switch (message.type) {
        case 'stats':
        case 'requests_per_ip': 
        requestsPerIpBody.innerHTML = formatRequestsPerIp(message.payload);
        break;
        case 'blocked_ips':
        blockedIpsList.innerHTML = formatBlockedIps(message.payload);
        break;
        case 'recent_requests':
        recentRequestsList.innerHTML = formatRecentRequests(message.payload);
        break;
        case 'system_logs':
        systemLogsDiv.innerHTML = formatSystemLogs(message.payload);
        break;
        case 'all_data': 
        if (message.payload.stats) requestsPerIpBody.innerHTML = formatRequestsPerIp(message.payload.stats);
        if (message.payload.blocked_ips) blockedIpsList.innerHTML = formatBlockedIps(message.payload.blocked_ips);
        if (message.payload.recent_requests) recentRequestsList.innerHTML = formatRecentRequests(message.payload.recent_requests);
        if (message.payload.system_logs) systemLogsDiv.innerHTML = formatSystemLogs(message.payload.system_logs);
        break;
        default:
        console.warn('Tipo de mensagem desconhecida:', message.type);
    }
    } catch (error) {
        console.error('Erro ao processar mensagem do WebSocket:', error, 'Dados:', event.data);
    }
    };

        socket.onerror = function(error) {
        console.error('Erro no WebSocket:', error);
        wsStatusDiv.textContent = 'Erro de ConexÃ£o';
        wsStatusDiv.className = 'ws-disconnected';
    };

        socket.onclose = function(event) {
        console.log('WebSocket desconectado. Tentando reconectar em 3 segundos...');
        wsStatusDiv.textContent = 'Desconectado. Reconectando...';
        wsStatusDiv.className = 'ws-disconnected';
        setTimeout(connectWebSocket, 3000); // Tenta reconectar apÃ³s 3 segundos
    };
    }

        
        async function resetBlockedIps() {
        resetStatusDiv.textContent = 'Resetando...';
        resetStatusDiv.className = 'status-info'; // Usar classes de status
        try {
        // O endpoint /reset deve ser um POST
        const response = await fetch('/reset', { method: 'POST' });
        const text = await response.text(); // Ou response.json() se o servidor responder com JSON

        if (response.ok) {
        resetStatusDiv.textContent = `Sucesso: ${text}`;
        resetStatusDiv.className = 'status-ok';
        // NÃ£o precisa mais fazer fetch manual aqui.
        // O servidor, ao processar /reset, deve enviar via WebSocket as atualizaÃ§Ãµes
        // para 'blocked_ips' e 'system_logs'.
    } else {
        resetStatusDiv.textContent = `Falha: ${text || response.statusText}`;
        resetStatusDiv.className = 'status-alert';
    }

    } catch (error) {
        console.error('Erro ao resetar IPs bloqueados:', error);
        resetStatusDiv.textContent = 'Erro crÃ­tico ao tentar resetar.';
        resetStatusDiv.className = 'status-alert';
    }
        
        setTimeout(() => {
        resetStatusDiv.textContent = '';
        resetStatusDiv.className = '';
    }, 5000);
    }

       
        document.getElementById('resetBlockedIps').addEventListener('click', resetBlockedIps);

        document.addEventListener('DOMContentLoaded', () => {
        requestsPerIpBody.innerHTML = '<tr><td colspan="2"><div class="empty-state">Aguardando dados...</div></td></tr>';
        blockedIpsList.innerHTML = '<li><div class="empty-state">Aguardando dados...</div></li>';
        recentRequestsList.innerHTML = '<li><div class="empty-state">Aguardando dados...</div></li>';
        systemLogsDiv.innerHTML = '<div class="empty-state">Aguardando dados...</div>';

        connectWebSocket();
    });

</script>
</script>
</body>
</html>
