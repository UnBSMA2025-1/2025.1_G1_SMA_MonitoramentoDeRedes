<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Dashboard de Monitoramento de Rede</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; 
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            font-size: 2.2rem; 
            color: #172b4d; 
            margin-bottom: 25px; 
            text-align: center;
            font-weight: 600;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); /* Ajuste minmax */
            gap: 25px; 
            width: 100%;
            max-width: 1300px; 
        }

        .panel {
            background-color: #ffffff;
            padding: 25px; 
            border-radius: 10px; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); 
            min-height: 220px; 
            display: flex; 
            flex-direction: column;
        }

        .panel h2 {
            font-size: 1.3rem; 
            color: #0052cc; 
            margin-top: 0;
            margin-bottom: 20px;
            border-bottom: 2px solid #dfe1e6; 
            padding-bottom: 12px;
            font-weight: 600;
        }

        
        table {
            width: 100%;
            border-collapse: collapse; 
        }

        thead th {
            background-color: #f7f8f9; 
            color: #172b4d;
            font-weight: 600; 
            padding: 12px 10px; 
            text-align: left;
            font-size: 0.95rem;
            border-bottom: 2px solid #dfe1e6;
        }

        tbody td {
            padding: 10px; 
            border-bottom: 1px solid #f0f2f5; 
            font-size: 0.9rem;
            color: #42526e; 
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        tbody tr:hover {
            background-color: #f7f8f9; 
        }

        ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
            flex-grow: 1; 
        }

        ul li {
            padding: 10px 5px; 
            border-bottom: 1px solid #f0f2f5;
            font-size: 0.9rem;
            color: #42526e;
            display: flex; 
            justify-content: space-between;
        }

        ul li:last-child {
            border-bottom: none;
        }

        .timestamp {
            font-size: 0.8em;
            color: #5e6c84; 
            margin-left: 8px; 
        }

        .log-entry {
            padding: 8px 5px; 
            border-bottom: 1px dotted #e0e0e0; 
            font-size: 0.85rem;
            color: #42526e;
            line-height: 1.5;
        }
        #system-logs { 
            max-height: 300px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        /* Status Colors */
        .status-ok { color: #00875a;  }
        .status-blocked { color: #de350b; font-weight: bold;  }
        .status-alert { color: #ffab00;  }
        .status-info { color: #0052cc; }


        /* Bot√£o de Reset */
        .reset-button-container {
            display: flex; 
            flex-direction: column; 
            align-items: center;
            gap: 10px; 
            margin-bottom: 25px;
        }

        button#resetBlockedIps {
            padding: 12px 25px; 
            background-color: #de350b;
            color: white;
            border: none;
            border-radius: 6px; 
            font-size: 1rem;
            font-weight: 600; 
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease;
        }

        button#resetBlockedIps:hover {
            background-color: #bf2600; 
            transform: translateY(-1px); 
        }
        button#resetBlockedIps:active {
            transform: translateY(0px); 
        }


        #resetStatus {
            margin-top: 5px; 
            font-size: 0.9rem;
            color: #172b4d;
            min-height: 1.2em; 
        }

    
        #ws-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.85rem;
            font-weight: 600;
            z-index: 1000;
        }

        .ws-connected {
            background-color: #e3fcef;
            color: #006644;
            border: 1px solid #00875a;
        }

        .ws-disconnected {
            background-color: #ffebe6;
            color: #bf2600;
            border: 1px solid #de350b;
        }

    
        .empty-state {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #5e6c84;
            font-style: italic;
            padding: 20px;
            text-align: center;
        }



    </style>
</head>
<body>
<h1>Dashboard de Monitoramento de Rede</h1>

<div class="reset-button-container">
    <button id="resetBlockedIps">Resetar IPs Bloqueados</button>
    <div id="resetStatus"></div>
</div>

<div class="dashboard-container">
    <div class="panel">
        <h2>üìä Requisi√ß√µes por IP</h2>
        <table id="requests-per-ip-table">
            <thead>
            <tr>
                <th>IP</th>
                <th>Contagem</th>
            </tr>
            </thead>
            <tbody id="requests-per-ip"></tbody>
        </table>
    </div>

    <div class="panel">
        <h2>üö´ IPs Bloqueados</h2>
        <ul id="blocked-ips"></ul>
    </div>

    <div class="panel">
        <h2>üì° Requisi√ß√µes Recentes</h2>
        <ul id="recent-requests"></ul>
    </div>

    <div class="panel">
        <h2>üìú Logs do Sistema</h2>
        <div id="system-logs"></div>
    </div>
</div>

<div id="ws-status">Conectando...</div>

<script>
   
   const API_BASE_URL = '/api'; // Ajuste se sua API estiver em outro prefixo

// Fun√ß√£o para buscar e preencher dados de um endpoint
async function fetchData(endpoint, elementId, formatter) {
    try {
        const response = await fetch(`${API_BASE_URL}${endpoint}`);
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        const data = await response.json();
        const element = document.getElementById(elementId);
        element.innerHTML = formatter(data);
    } catch (error) {
        console.error(`Erro ao buscar dados de ${endpoint}:`, error);
        const element = document.getElementById(elementId);
        element.innerHTML = `<li class="status-alert">Erro ao carregar dados.</li>`;
    }
}

// Formatadores para cada tipo de dado
function formatRequestsPerIp(data) {
    let html = '';
    for (const ip in data) {
        html += `<tr><td>${ip}</td><td>${data[ip]}</td></tr>`;
    }
    if (html === '') return '<tr><td colspan="2">Nenhuma requisi√ß√£o registrada.</td></tr>';
    return html;
}

function formatBlockedIps(data) {
    if (data.length === 0) return '<li class="status-ok">Nenhum IP bloqueado.</li>';
    return data.map(ip => `<li class="status-blocked">${ip}</li>`).join('');
}

function formatRecentRequests(data) {
    if (data.length === 0) return '<li>Nenhuma requisi√ß√£o recente.</li>';
    return data.slice(0, 15).map(req => // Pega as √∫ltimas 15 para n√£o sobrecarregar
        `<li>${req.ip} <span class="timestamp">(${new Date(req.timestamp).toLocaleString()})</span></li>`
    ).join('');
}

function formatSystemLogs(data) {
    if (data.length === 0) return '<div class="log-entry">Nenhum log no sistema.</div>';
    return data.slice(0, 20).map(log => // Pega os √∫ltimos 20 logs
        `<div class="log-entry">${log.replace(/\[ROUTER\] IP bloqueado:/g, '<span class="status-blocked">[ROUTER] IP bloqueado:</span>')}</div>`
    ).join('');
}

// Fun√ß√£o para resetar IPs bloqueados
async function resetBlockedIps() {
    const statusDiv = document.getElementById('resetStatus');
    try {
        statusDiv.textContent = 'Resetando...';
        const response = await fetch('/reset', { method: 'POST' });
        const text = await response.text();
        statusDiv.textContent = text;
        // Atualiza a lista de IPs bloqueados ap√≥s o reset
        fetchData('/blocked', 'blocked-ips', formatBlockedIps);
        fetchData('/logs', 'system-logs', formatSystemLogs); // Logs tamb√©m podem mudar
    } catch (error) {
        console.error('Erro ao resetar IPs bloqueados:', error);
        statusDiv.textContent = 'Erro ao resetar.';
    }
}


// Carregar dados e configurar atualiza√ß√£o peri√≥dica
function loadAllData() {
    fetchData('/stats', 'requests-per-ip', formatRequestsPerIp);
    fetchData('/blocked', 'blocked-ips', formatBlockedIps);
    fetchData('/requests', 'recent-requests', formatRecentRequests);
    fetchData('/logs', 'system-logs', formatSystemLogs);
}

// Adiciona o event listener ao bot√£o de reset
document.getElementById('resetBlockedIps').addEventListener('click', resetBlockedIps);

// Carregar dados inicialmente
loadAllData();

// Atualizar a cada 5 segundos
setInterval(loadAllData, 5000);
</script>
</body>
</html>
