<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Dashboard de Monitoramento de Rede</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f9ff;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 1200px;
        }
        .panel {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            min-height: 200px;
        }
        .panel h2 {
            font-size: 1.4rem;
            color: #1e3a8a;
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 2px solid #dbeafe;
            padding-bottom: 10px;
        }
        ul, table {
            list-style-type: none;
            padding: 0;
            width: 100%;
        }
        li, td, th {
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        li:last-child, td:last-child {
            border-bottom: none;
        }
        th {
            text-align: left;
            background-color: #f9fafb;
            color: #1e3a8a;
        }
        .timestamp {
            font-size: 0.8em;
            color: #666;
        }
        .log-entry {
            padding: 6px 0;
            border-bottom: 1px dotted #eee;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .status-ok { color: green; }
        .status-blocked { color: red; font-weight: bold; }
        .status-alert { color: orange; }

        h1 {
            font-size: 2rem;
            color: #1e3a8a;
            margin-bottom: 30px;
            text-align: center;
        }

        /* Estilo para o bot√£o de reset */
        .reset-button-container {
            text-align: center;
            margin-bottom: 20px;
        }

        button#resetBlockedIps {
            padding: 10px 20px;
            background-color: #e53e3e; /* Cor vermelha para indicar perigo/reset */
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        button#resetBlockedIps:hover {
            background-color: #c53030;
        }
        #resetStatus {
            margin-top: 10px;
            font-size: 0.9rem;
        }

    </style>
</head>
<body>
<h1>Dashboard de Monitoramento de Rede</h1>

<div class="reset-button-container">
    <button id="resetBlockedIps">Resetar IPs Bloqueados</button>
    <div id="resetStatus"></div>
</div>

<div class="dashboard-container">
    <div class="panel">
        <h2>üìä Requisi√ß√µes por IP</h2>
        <table id="requests-per-ip-table">
            <thead>
            <tr>
                <th>IP</th>
                <th>Contagem</th>
            </tr>
            </thead>
            <tbody id="requests-per-ip"></tbody>
        </table>
    </div>

    <div class="panel">
        <h2>üö´ IPs Bloqueados</h2>
        <ul id="blocked-ips"></ul>
    </div>

    <div class="panel">
        <h2>üì° Requisi√ß√µes Recentes</h2>
        <ul id="recent-requests"></ul>
    </div>

    <div class="panel">
        <h2>üìú Logs do Sistema</h2>
        <div id="system-logs"></div>
    </div>
</div>

<script>
    const API_BASE_URL = '/api'; // Ajuste se sua API estiver em outro prefixo

    // Fun√ß√£o para buscar e preencher dados de um endpoint
    async function fetchData(endpoint, elementId, formatter) {
        try {
            const response = await fetch(`${API_BASE_URL}${endpoint}`);
            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }
            const data = await response.json();
            const element = document.getElementById(elementId);
            element.innerHTML = formatter(data);
        } catch (error) {
            console.error(`Erro ao buscar dados de ${endpoint}:`, error);
            const element = document.getElementById(elementId);
            element.innerHTML = `<li class="status-alert">Erro ao carregar dados.</li>`;
        }
    }

    // Formatadores para cada tipo de dado
    function formatRequestsPerIp(data) {
        let html = '';
        for (const ip in data) {
            html += `<tr><td>${ip}</td><td>${data[ip]}</td></tr>`;
        }
        if (html === '') return '<tr><td colspan="2">Nenhuma requisi√ß√£o registrada.</td></tr>';
        return html;
    }

    function formatBlockedIps(data) {
        if (data.length === 0) return '<li class="status-ok">Nenhum IP bloqueado.</li>';
        return data.map(ip => `<li class="status-blocked">${ip}</li>`).join('');
    }

    function formatRecentRequests(data) {
        if (data.length === 0) return '<li>Nenhuma requisi√ß√£o recente.</li>';
        return data.slice(0, 15).map(req => // Pega as √∫ltimas 15 para n√£o sobrecarregar
            `<li>${req.ip} <span class="timestamp">(${new Date(req.timestamp).toLocaleString()})</span></li>`
        ).join('');
    }

    function formatSystemLogs(data) {
        if (data.length === 0) return '<div class="log-entry">Nenhum log no sistema.</div>';
        return data.slice(0, 20).map(log => // Pega os √∫ltimos 20 logs
            `<div class="log-entry">${log.replace(/\[ROUTER\] IP bloqueado:/g, '<span class="status-blocked">[ROUTER] IP bloqueado:</span>')}</div>`
        ).join('');
    }

    // Fun√ß√£o para resetar IPs bloqueados
    async function resetBlockedIps() {
        const statusDiv = document.getElementById('resetStatus');
        try {
            statusDiv.textContent = 'Resetando...';
            const response = await fetch('/reset', { method: 'POST' });
            const text = await response.text();
            statusDiv.textContent = text;
            // Atualiza a lista de IPs bloqueados ap√≥s o reset
            fetchData('/blocked', 'blocked-ips', formatBlockedIps);
            fetchData('/logs', 'system-logs', formatSystemLogs); // Logs tamb√©m podem mudar
        } catch (error) {
            console.error('Erro ao resetar IPs bloqueados:', error);
            statusDiv.textContent = 'Erro ao resetar.';
        }
    }


    // Carregar dados e configurar atualiza√ß√£o peri√≥dica
    function loadAllData() {
        fetchData('/stats', 'requests-per-ip', formatRequestsPerIp);
        fetchData('/blocked', 'blocked-ips', formatBlockedIps);
        fetchData('/requests', 'recent-requests', formatRecentRequests);
        fetchData('/logs', 'system-logs', formatSystemLogs);
    }

    // Adiciona o event listener ao bot√£o de reset
    document.getElementById('resetBlockedIps').addEventListener('click', resetBlockedIps);

    // Carregar dados inicialmente
    loadAllData();

    // Atualizar a cada 5 segundos
    setInterval(loadAllData, 5000);
</script>
</body>
</html>